---
- hosts: all
  vars_files:
    - vars/all.yml
  remote_user: "{{ remote_user }}"
  tasks:

  - name: Create directory for app
    become: True
    file: path={{ root }} state=directory owner={{ remote_user }} group=www-data

  - name: Create logging directory
    become: True
    file: path={{ loggingLocation }} state=directory owner={{ remote_user }}

  - name: checkout repo
    git: repo={{ git }} dest={{ root }} force=yes accept_hostkey=True version={{ gitVersion }}

  - name: install backend/npm dependencies
    npm: path={{ root }}

  - name: remove current im_processor build if existing
    file: path={{ root }}/im_processor/build state=absent

  - name: install im_processor
    shell: npm install
    args:
      chdir: "{{ root }}/im_processor"

  - name: install frontend/bower dependencies
    bower: path={{ root }}

  - name: replace frontend config (1)
    replace:
      dest={{ root }}/public/scripts/config.js
      regexp="api:(.*)"
      replace="api:'http://alagoda.at:3991/api/v1',"

  - name: replace frontend config (2)
    replace:
      dest={{ root }}/public/scripts/config.js
      regexp="socket:(.*)"
      replace="socket:'http://alagoda.at:3000',"

  - name: replace frontend config (3)
    replace:
      dest={{ root }}/config.js
      regexp="publicDomain:(.*)"
      replace="publicDomain:'http://im.alagoda.at',"

  - name: Stop Node.js app
    command: forever stop {{ root }}/server.js
    ignore_errors: yes # Says it did not work, but it works!

  - name: Start Node.js app
    command: forever start -al {{ loggingLocation }}/forever.log {{ root }}/server.js