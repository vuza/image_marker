---
- hosts: all
  become: True
  tasks:

  - name: Create directory for app
    file: path=/var/node/image_marker state=directory

  - name: checkout repo
    git: repo=git@github.com:vuza/image_marker.git dest=/var/node/image_marker force=yes accept_hostkey=True version=develop

  - name: install backend/npm dependencies
    npm: path=/var/node/image_marker

  - name: install im_processor
    npm: path=/var/node/image_marker/im_processor

  - name: install frontend/bower dependencies
    bower: path=/var/node/image_marker

  - name: Check list of Node.js apps running
    command: forever list
    register: forever_list
    changed_when: false

  - name: Start Node.js app
    command: forever start /var/node/image_marker
    when: "forever_list.stdout.find('/var/node/image_marker') == -1"